{% extends "base.html" %}

{% block extrahead %}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/blurbs.css"/>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery-1.6.2.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery-ui-1.8.16.custom.min.js"></script>

<script type="text/javascript">
function new_category(name) {
    var cat = $('<div class="category">');
    var header = $('<div class="category-header">');
    header.html(name);
    var list = $('<div class="category-list">');
    list.sortable({
        connectWith: '#blurb-list, div.category-list'
    });
    cat.append(header);
    cat.append(list);
    cat.dblclick(function() {
        $(this).find('div.blurb').each(function () {
            $('#blurb-list').append($(this));
        });
        $(this).remove();
    });
    $('#pipeline').append(cat);
}

function new_event(lines) {
    var newevent = $('<div class="event">');
    var title = $('<div class="event-title">');
    title.html(lines[0]);
    var content = $('<div class="event-description">');
    content.html(lines.slice(1).join("<br/>"));
    newevent.append(title);
    newevent.append(content);
    $('#events').append(newevent);
    newevent.dblclick(function() {
        $(this).remove();
    });
    $('#new-event').val('');  
}

function get_pipeline() {
    var headers = [];
    $('#pipeline .category').each(function() {
        var blurbs = [];
        $(this).find('.blurb').each(function() {
            blurbs.push(parseInt($(this).attr('id')));
        });
        headers.push({
            'title': $(this).find('.category-header').html(),
            'blurbs': blurbs
        });
    });
    var events = [];
    var index = 1;
    $('#events .event').each(function() {
        events.push({
            'index': index,
            'title': $(this).find('.event-title').html(),
            'lines': $(this).find('.event-description').html().split("<br>")
        });
        index = index + 1;
    });
    return JSON.stringify({
        'headers': headers,
        'events': events
    });
}

$(function() {
    $('#pipeline').sortable();
    $('#events').sortable();
    $('#blurb-list').sortable({
        connectWith: 'div.category-list'
    });
    $('#new-category').click(function() {
        var name = prompt('Category name', '');
        if (name)
            new_category(name);
    });
    $('div.blurb').click(function() {
        $('div.blurb-display:not(.hidden)').addClass('hidden');
        $('#blurb-' + $(this).attr('id')).removeClass('hidden');
    });
    $('#generate').submit(function() {
        var input = $('<input>');
        input.attr('type', 'hidden');
        input.attr('name', 'pipeline');
        input.attr('value', get_pipeline());
        $(this).append(input);
    });
    $('#add-event').click(function() {
        if ($('#new-event').val()) {
            var lines = $('#new-event').val().split("\n");
            new_event(lines);
        }
    });
});
</script>
{% endblock %}

{% block body %}

<div id="blurb-list">
    <h2>Approved blurbs</h2>
    {% for blurb in blurbs %}
    <div id="{{ blurb.id }}" class="blurb">{{ blurb.title }}</div>
    {% endfor %}
</div>

<div id="pipeline">
    <h2>Pipeline Contents
    <button id="new-category">New category</button>
    </h2>
</div>

{% for blurb in blurbs %}
    <div class="blurb-display hidden" id="blurb-{{ blurb.id }}">{{ blurb.body|safe }}</div>
{% endfor %}

<div id="events">
    <h2>Events 
    <button id="add-event">Add event</button>
    </h2>
    <textarea id="new-event"></textarea>
</div>
 

<form id="generate" action="" target="_blank" method="post">
{% csrf_token %}
<input type="submit" value="Generate pipeline!"/>
</form>

{% endblock %}
